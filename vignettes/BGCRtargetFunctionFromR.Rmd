---
title: "R-based Biome-BGC functionallity"
author: "CBoisvenue"
date: "13/10/2021"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{R-based Biome-BGC functionallity}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
#library(BiomeBGCR)
```

# Biome-BGC control from R/SpaDES

Biome-BGC requires at least three files.
Each of these files should be accessible in the R environment.
Each section below looks at the individual files and suggests an avenue for control.

# Initialization file

This file will be referred to as the `.ini` file.
Page 4 of the `bgc_users_guide.pdf` describes in detail the `.ini` file structure and requirements.
All the sections and parameters defined in this file have to be modifiable either via a global script in SpaDES (example below) or by have some of the parameters in an R-object (in the `sim$`) that can be modified.
An example of a global script and of the section that would be used in a module to build an object (`sim$bgc.ini`) are given below (2 separate code blocks).
Note that each R-object in the lists match the blocks in the `.ini` file example provided in the `bgc_users_guide.pdf`.
Some of these objects, the ones that are much less likely to change are in the module script and the ones with user-control are in the global script.


```{r example_global_script_for_SpaDES, echo = TRUE, eval = FALSE}
library(Require)
Require(c("PredictiveEcology/BiomeBGCRutils@development",
          "PredictiveEcology/SpaDES.core@development",
          "PredictiveEcology/SpaDES.install@development"))

options("reproducible.useRequire" = TRUE)
cacheDir <- reproducible::checkPath("cache", create = TRUE)
moduleDir <- reproducible::checkPath("modules")
inputDir <- reproducible::checkPath("inputs", create = TRUE)
outputDir <- reproducible::checkPath("outputs", create = TRUE)
scratchDir <- file.path(tempdir(), "scratch", "BiomeBGC") %>% reproducible::checkPath(create = TRUE)

# get BGC module (https://github.com/PredictiveEcology/BGC) and save to moduleDir
getModule("PredictiveEcology/BGC@development", overwrite = FALSE, modulePath = modulePath)

# this sets options globally
setPaths(
  cachePath = cacheDir,
  modulePath = moduleDir,
  inputPath = inputDir,
  outputPath = outputDir,
  rasterPath = file.path(scratchDir, "raster"),
  terraPath = file.path(scratchDir, "terra")
)

times <- list(start = 1950, end = 1994)

## this is an example of how .ini input could be controlled in this global script,
## passing 
params = list(
  BGC = list(
    epc_file = file.path(prjPaths$inputPath, "epc", "nameOfepcFile"),            ## TODO
    met_input = file.path(prjPaths$inputPath, "metData", "nameOfMetFile"),       ## TODO
    restart_inputFile =  file.path(prjPaths$inputPath, "restart", "nameOfFile"), ## TODO
    restart_outputFile = file.path(prjPaths$outputPath, "restart", "nameOfFile"), ## TODO
    ## ---------------------------------------------------------------------------------------------
    .plots = c("screen", "png", "raw")
  )
)
```

# Meteorology

This file will be referred to as the `.mtc43` file. Meteorological data will come from different sources. 
The reading in of these files is anticipated to be via URL or FTP site which is anticipated to be done via a module. 
Ideally, the read-in data would be transformed via an R function to match the required structure of the c-based scripts. 
Note that the example runs for one point, but that the `.mtc43` files will have to be modified so that the scripts will be able to handle multiple points (points representing pixels or `pixelGroups`).
We could test multiple sites using the data from Boisvenue and Running (2010) which is easily available.

# Ecophysioligical constants

This file will be referred to as the `.epc` file.
Similarly to the `.ini` file, all parameters need to be accessible in the R/SpaDES environment.

# Other considerations

Restart files are the result of running Biome-BGC in a spinup mode. 
In the R/SpaDES environment, we would like to be able to start simulations from another source than a restart (something based on actual data), or a least be able to adjust the restart file to match data.

## Potential source of Met data coming from MODIS

MOD17 is the NPP calculation derived from the sensor Terra on the Earth Observation System. 
This derivation is described in the `MOD17C61UsersGuideV11Mar112021.pdf`.
Biome-BGC is used to derive the Biome Properties Look-up Table (BPLUT) for the MOD17 calculations.
The MOD17 algorithm computes productivity at a daily time step. 
This is made possible by the daily global meteorological reanalysis data, including average and minimum air temperature, incident PAR and specific humidity, provided by the GMAO/NASA. 
This may be a source of met data we need to consider.
BioSIM is another.
More info on the MOD17 Met data derivation:
The current version of GMAO/NASA is hourly time step data set with about half-degree spatial resolution (0.5 Latitude degree by 0.67 Longitude degree) generated by GEOS-5 data assimilation system (Rienecker et al. 2008). 
They aggregated hourly data into daily scale for daily meteorological inputs to MOD17.
For VPD, we are using daytime VPD not daily as photosynthesis is largely occurring during daytime. 
Daytime is determined when hourly downward solar radiation is above zero. 
Daytime VPD is the difference between daytime saturated vapor pressure estimated with daytime average air temperature and daily vapor pressure. 
Daily vapor pressure is calculated with specific humidity and surface air pressure.
GMAO/NASA, like other global meteorological reanalyses, contains uncertainties, especially for regions with poor weather station coverage and small-scale convection processes which cannot be sufficiently depicted by coarse resolution meteorological data assimilation system. 
Therefore, uncertainties in GMAO/NASA and subsequent estimated GPP/NPP are higher in tropics than non-tropical regions (Zhao et al. 2006).

# Functions and other info

Could use the PhD runs to run "multiple" pixels (Boisvenue and Running 2010)

# binToText function

`binToText` is a function that converts single floating point binary data into ASCII text data.
This function was written for Biome BGC output but could be used for any data that was single floating point precision and was in tabular form.
It takes directory arguments (or `NA`s if you are already in the correct directory, a unique suffix to identify the file or files you want to convert (or `NA` if you want to convert all files), the number of variables (columns), the number of years (rows), and the starting year (first row, this could also be `NA` if you would like the output to start at 0.
Modified for any specified no of var (`varNo`).

C. Boisvenue Oct. 16, 2006

```{r binToText, eval=FALSE, echo=TRUE}
# running it - works!
binToText(
  "C:/Celine/Active_UMontana/Research/HewlettNCEP/runs/runs4_noDist",
  "C:/Celine/Active_UMontana/Research/HewlettNCEP/runs/runs4_noDist",
  ".annavgout", 24, 140, 1950
)
# C:\Celine\Active_UMontana\Research\HewlettNCEP\runs\runs4_noDist
# CelineRuns3\\outputs_daily
# "C:\\Celine\\Active_UMontana\\Research\\HewlettNCEP\\runs\\dist2\\biomebgc-4.3beta2\\outputs_dist1
# "C:\\Celine\\Active_UMontana\\Research\\HewlettNCEP\\runs\\dist2\\biomebgc-4.3beta2\\outputs_dist1
```

# References

- Boisvenue, C., & Running, S. (2010). Simulations show decreasing carbon stocks and potential for carbon emissions in Rocky Mountain forests over the next century. Ecological Applications, 20(5), 1302–1319.
- Rienecker, M. M., Suarez, M. J., Todling, R., Bacmeister, J., Takacs, L., Liu, H. C., Gu, W., Sienkiewicz, M., Koster, R. D., Gelaro, R., Stajner, I., and Nielsen, J. E. (2008). The GEOS-5 data assimilation system – Documentation of versions 5.0.1, 5.1.0. Technical Report Series on Global Modeling and Data Assimilation, ed Suarez, M. J. (National Aeronautics and Space Administration, Washington, DC), 95.
- Zhao, M., Running, S. W., and Nemani, R. R. (2006). Sensitivity of Moderate Resolution Imaging Spectroradiometer (MODIS) terrestrial primary production to the accuracy of
meteorological reanalyses. Journal of Geophysical Research, 111, G01002.
